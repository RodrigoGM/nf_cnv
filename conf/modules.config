/*
 * Process resource allocation and configuration
 * Pipeline-specific settings that remain consistent across projects
 */

process {
    // Default resources for all processes
    cpus = 1
    memory = '8.GB'
    time = '4.h'
    
    // ================================
    // FASTQ Processing
    // ================================
    withName: CAT_FASTQ {
        cpus = 1
        memory = '12.GB'
        time = '4.h'
	cleanup = true  // Clean up after BARCODE_SPLIT uses output
        publishDir = [
            path: { "${params.outdir}/results/merged" },
            mode: 'copy',
            pattern: "*.fastq.gz",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'CHECK_FASTQ_PAIRS|CHECK_CELL_FASTQ_PAIRS' {
        cpus = 1
        memory = '4.GB'
        time = '1.h'
	cleanup = true  // // Clean up check files after aggregation
    }
    
    withName: 'AGGREGATE_*|CREATE_FASTQ_MANIFEST' {
        cpus = 1
        memory = '2.GB'
        time = '30.min'
    }
    
    // ================================
    // Demultiplexing
    // ================================
    withName: BARCODE_SPLIT {
        cpus = 2
        memory = '8.GB'
        time = '24.h'
    }
    
    // ================================
    // Quality Control
    // ================================
    withName: FASTQC {
        cpus = 1
        memory = '6.GB'
        time = '2.h'
        publishDir = [
            path: { "${params.outdir}/results/qc/fastqc" },
            mode: 'copy', 
            pattern: "*.{html,zip}",
            saveAs: { fn -> fn == 'versions.yml' ? null : fn }
        ]
    }
    
    withName: FASTQ_SCREEN {
        cpus = 4
        memory = '64.GB'
        time = '8.h'
        errorStrategy = 'ignore'
        publishDir = [
            path: { "${params.outdir}/results/qc/fastq_screen" },
            mode: 'copy',
            pattern: '*.{html,txt,png}'
        ]
    }

//    withName: 'PRESEQ_CCURVE|PRESEQ_LCEXTRAP|PRESEQ_GCEXTRAP' {
//        cpus = 1
//        memory = '4.GB'
//        time = '2.h'
//        errorStrategy = 'ignore'  // Skip empty BAMs
//        publishDir = [
//            path: { "${params.outdir}/results/qc/preseq/${task.process.tokenize('_')[-1].toLowerCase()}" },
//            mode: 'copy',
//            pattern: '*.txt'
//        ]
//    }
//    
//    withName: PRESEQ_CCURVE {
//        ext.args = '-s 100000 -v'  // Custom step size and verbose
//    }
//    
//    withName: PRESEQ_LCEXTRAP {
//        ext.args = '-e 1000000000 -s 10000000 -Q'  // Quick mode, custom extrap
//    }
//    
//    withName: PRESEQ_GCEXTRAP {
//        ext.args = '-e 100000000 -s 10000000 -Q'  // Quick mode, custom extrap
//    }

    // withName: 'nf-core:multiqc:MULTIQC' {
    withName: 'MULTIQC' {
        cpus = 2
        memory = '32.GB'
        time = '8.h'
        publishDir = [
            [
                path: { "${params.outdir}/results/cnv_summary" },
                mode: 'copy',
                pattern: '*.html',
                saveAs: { filename -> 
                    filename.equals('versions.yml') ? null : "${params.project.toUpperCase()}_QC.html" 
                }
            ],
            [
                path: { "${params.outdir}/results/cnv_summary" },
                mode: 'copy', 
                pattern: '*_data',
                saveAs: { filename -> "${params.project.toUpperCase()}_QC_data" }
            ]
        ]
        ext.args = { [
            "--title '${params.project} Quality Control Report'",
            "--force",
            "--dirs",
            "--dirs-depth 2"
        ].join(' ').trim() }
    }


    // ================================
    // Alignment Pipeline
    // ================================
    withName: BWA_MEM {
        cpus = 8
        memory = '32.GB'
        time = '8.h'
    	cleanup = true  // Clean up unsorted BAMs after COLLATE_BAM
    }
    
    withName: VALIDATE_BAM {
        cpus = 1
        memory = '4.GB'
        time = '30.min'
    }
    
    withName: 'COLLATE_BAM|FIXMATE_BAM' {
        cpus = 2
        memory = '8.GB'
        time = '2.h'
    	cleanup = true  // Clean up unsorted BAMs after COLLATE_BAM
    }
    
    withName: SORT_BAM {
        cpus = 4
        memory = '16.GB'
        time = '4.h'
    }
    
    withName: 'MARK_DUPLICATES|REMOVE_DUPLICATES' {
        cpus = 2
        memory = '16.GB'
        time = '4.h'
	cleanup = false	// Clean up check files after aggregation
    }
    
    withName: MARK_DUPLICATES {
        publishDir = [
            path: { "${params.outdir}/results/bwa_out_md" },
            mode: 'copy',
            pattern: "*.${params.genome}.PE.md.bam*"
        ]
    }
    
    withName: REMOVE_DUPLICATES {
        publishDir = [
            path: { "${params.outdir}/results/bwa_out_dd" },
            mode: 'copy',
            pattern: "*.${params.genome}.PE.dd.bam*"
        ]
    }
    
    // ================================
    // BAM Quality Control
    // ================================
    withName: QUALIMAP_BAMQC {
        cpus = 1
        memory = '24.GB'
        time = '4.h'
        publishDir = [
            path: { "${params.outdir}/results/qc/qualimap" },
            mode: 'copy',
            pattern: '*'
        ]
    }
    
    withName: PICARD_COLLECTMULTIPLEMETRICS {
        cpus = 1
        memory = '8.GB'
        time = '2.h'
        errorStrategy = 'ignore'
        publishDir = [
            path: { "${params.outdir}/results/qc/picard_metrics" },
            mode: 'copy',
            pattern: '*.{txt,pdf}'
        ]
    }
    
    withName: PICARD_COLLECTINSERTSIZEMETRICS {
        cpus = 1
        memory = '4.GB'
        time = '1.h'
        errorStrategy = 'ignore'
        publishDir = [
            path: { "${params.outdir}/results/qc/insert_size" },
            mode: 'copy',
            pattern: '*.{txt,pdf}'
        ]
    }
    
    withName: SAMTOOLS_FLAGSTAT {
        cpus = 1
        memory = '2.GB'
        time = '30.min'
        publishDir = [
            path: { "${params.outdir}/results/qc/flagstat" },
            mode: 'copy',
            pattern: '*.flagstat'
        ]
    }
    
    withName: SAMTOOLS_STATS {
        cpus = 1
        memory = '2.GB'
        time = '30.min'
        publishDir = [
            path: { "${params.outdir}/results/qc/samtools_stats" },
            mode: 'copy',
            pattern: '*.stats'
        ]
    }
    
    withName: SAMTOOLS_IDXSTATS {
        cpus = 1
        memory = '1.GB'
        time = '15.min'
        publishDir = [
            path: { "${params.outdir}/results/qc/idxstats" },
            mode: 'copy',
            pattern: '*.idxstats'
        ]
    }
    
    
    // ================================
    // CNV Analysis
    // ================================
    withName: GET_BIN_COUNTS {
        cpus = 2
        memory = '8.GB'
        time = '2.h'
    }
    
    withName: CNV_PROFILE {
        cpus = 2
        memory = '8.GB'
        time = '4.h'
    }
    
    withName: AGGREGATE_SEG_MATRICES {
        cpus = 2
        memory = { params.aggregate_seg_memory ?: '32.GB' }
        time = '2.h'
        publishDir = [
            path: { "${params.outdir}/results/cnv_summary" },
            mode: 'copy',
            pattern: 'matrix_*.txt'
        ]
    }
    
    withName: CNV_PLOIDY_SUMMARY {
        cpus = 1
        memory = '2.GB'
        time = '15.min'
        publishDir = [
            path: { "${params.outdir}/results/cnv_summary" },
            mode: 'copy',
            pattern: 'ploidy_summary_*.{txt,csv}'
        ]
    }
    
    withName: CREATE_CELL_PHENOTYPE_TEMPLATE {
        cpus = 1
        memory = '2.GB'
        time = '15.min'
        publishDir = [
            path: { "${params.outdir}/results/cnv_summary" },
            mode: 'copy',
            pattern: 'cell_phenotype.txt'
        ]
    }
}
