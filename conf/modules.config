/*
 * Process resource allocation and configuration
 * Pipeline-specific settings that remain consistent across projects
 */

// File staging and transfer settings
filePorter {
    maxRetries = 5              // Retry file transfers up to 3 times
    maxTransfers = 50           // Max concurrent transfers
    pollInterval = '15 sec'      // Check interval for transfers
}

// Robust file handling for NFS environments
env {
    NXF_FILE_STAGE_TIMEOUT = '30 min'
    NXF_FILE_COPY_TIMEOUT = '30 min'
}

process {

    // Add delay for file operations
    beforeScript = 'sleep 3 ; sync'    // Wait 3 seconds before starting then sync
    afterScript = 'sleep 3 ; sync ; sleep 3'

    // Default resources for all processes
    cpus = 1
    memory = '8.GB'
    time = '4.h'

    cleanup = true  // Clean up when possible
    
    // ================================
    // FASTQ Processing
    // ================================
    withName: CAT_FASTQ {
        cpus = 1
        memory = '12.GB'
        time = '4.h'
	beforeScript = 'sleep 5; sync'  // Extra delay for large files
        publishDir =  [
            path: { "${params.outdir}/results/merged" },
            mode: 'copy',
            pattern: "*.fastq.gz",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
	    enabled: params.publish_merged_fastq
        ] 
    }
    
    withName: 'CHECK_FASTQ_PAIRS|CHECK_CELL_FASTQ_PAIRS' {
        cpus = 1
        memory = '4.GB'
        time = '1.h'
    }
    
    withName: 'AGGREGATE_*|CREATE_FASTQ_MANIFEST' {
        cpus = 1
        memory = '2.GB'
        time = '30.min'
    }
    
    // ================================
    // Demultiplexing
    // ================================
    withName: BARCODE_SPLIT {
        cpus = 2
        memory = '8.GB'
        time = '24.h'
	publishDir = [
            path: { "${params.outdir}/results/wsplit" },
            mode: 'copy',
            pattern: "*_R{1,2}.fastq.gz",
    	    enabled: params.publish_merged_fastq
        ]
    }
    
    // ================================
    // Quality Control
    // ================================
    withName: FASTQC {
        cpus = 1
        memory = '6.GB'
        time = '2.h'
        //publishDir = [
        //    path: { "${params.outdir}/results/qc/fastqc" },
        //    mode: 'copy', 
        //    pattern: "*.{html,zip}",
        //    saveAs: { fn -> fn == 'versions.yml' ? null : fn },
	//    enabled: false
        //]
    }
    
    withName: FASTQ_SCREEN {
        cpus = 4
        memory = '64.GB'
        time = '8.h'
        errorStrategy = 'ignore'
        publishDir = [
            path: { "${params.outdir}/results/qc/fastq_screen" },
            mode: 'copy',
            pattern: '*.{html,txt,png}',
	    enabled: false
        ]
    }

//    withName: 'PRESEQ_CCURVE|PRESEQ_LCEXTRAP|PRESEQ_GCEXTRAP' {
//        cpus = 1
//        memory = '4.GB'
//        time = '2.h'
//        errorStrategy = 'ignore'  // Skip empty BAMs
//        publishDir = [
//            path: { "${params.outdir}/results/qc/preseq/${task.process.tokenize('_')[-1].toLowerCase()}" },
//            mode: 'copy',
//            pattern: '*.txt'
//        ]
//    }
//    
//    withName: PRESEQ_CCURVE {
//        ext.args = '-s 100000 -v'  // Custom step size and verbose
//    }
//    
//    withName: PRESEQ_LCEXTRAP {
//        ext.args = '-e 1000000000 -s 10000000 -Q'  // Quick mode, custom extrap
//    }
//    
//    withName: PRESEQ_GCEXTRAP {
//        ext.args = '-e 100000000 -s 10000000 -Q'  // Quick mode, custom extrap
//    }

    // withName: 'nf-core:multiqc:MULTIQC' {
    withName: 'MULTIQC' {
        cpus = 2
        memory = '32.GB'
        time = '8.h'
        publishDir = [
            [
                path: { "${params.outdir}/results/cnv_summary" },
                mode: 'copy',
                pattern: '*.html',
                saveAs: { filename -> 
                    filename.equals('versions.yml') ? null :
		    "${params.project.toUpperCase()}_QC.html"
                }
            ],
            [
                path: { "${params.outdir}/results/cnv_summary" },
                mode: 'copy', 
                pattern: '*_data',
                saveAs: { filename -> "${params.project.toUpperCase()}_QC_data" }
            ]
        ]
        ext.args = { [
            "--title '${params.project} Quality Control Report'",
            "--force",
            "--dirs",
            "--dirs-depth 2"
        ].join(' ').trim() }
    }


    // ================================
    // Alignment Pipeline
    // ================================
    withName: BWA_MEM {
        cpus = 8
        memory = '32.GB'
        time = '8.h'
    }
    
    withName: VALIDATE_BAM {
        cpus = 1
        memory = '4.GB'
        time = '30.min'
    }
    
    withName: 'COLLATE_BAM|FIXMATE_BAM' {
        cpus = 2
        memory = '8.GB'
        time = '2.h'
    }
    
    withName: SORT_BAM {
        cpus = 4
        memory = '16.GB'
        time = '4.h'
    }
    
    withName: 'MARK_DUPLICATES|REMOVE_DUPLICATES' {
        cpus = 2
        memory = '16.GB'
        time = '4.h'
	beforeScript = 'sleep 5; sync'  // Extra delay for large files
    }
    
//    withName: REMOVE_DUPLICATES {
//        publishDir =  [
//            path: { "${params.outdir}/results/bwa_out_dd" },
//            mode: 'copy',
//            pattern: "*.${params.genome}.PE.dd.bam*",
//	    enabled: params.publish_dd_bam
//    	]
//    }

    withName: 'FILTER_AND_EXTRACT_READS' {
        beforeScript = 'sleep 5; sync'  // Extra delay for large files
//      publishDir = [
//           path: { "${params.outdir}/results/bwa_out_fw" },
//           mode: 'copy',
//           pattern: "*.${params.genome}.PE_*.bam*",
//   	    enabled: params.publish_dd_bam
//    	]
    }

    // ================================
    // BAM Quality Control
    // ================================
    withName: QUALIMAP_BAMQC {
        cpus = 2
        memory = { 24.GB * task.attempt }
        time = '4.h'
	beforeScript = 'sleep 5; sync'  // Extra delay for large files
//        publishDir = [
//            path: { "${params.outdir}/results/qc/qualimap" },
//            mode: 'copy',
//            pattern: '*',
//	    enabled: false
//        ]
    }
    
    withName: PICARD_COLLECTMULTIPLEMETRICS {
        cpus = 2
        memory = '8.GB'
        time = '2.h'
        errorStrategy = 'ignore'
//        publishDir = [
//            path: { "${params.outdir}/results/qc/picard_metrics" },
//            mode: 'copy',
//            pattern: '*.{txt,pdf}',
//	    enabled: false
//        ]
    }
    
    withName: SAMTOOLS_FLAGSTAT {
        cpus = 2
        memory = '2.GB'
        time = '30.min'
        //publishDir = [
        //    path: { "${params.outdir}/results/qc/flagstat" },
        //    mode: 'copy',
        //    pattern: '*.flagstat',
        //]
    }
    
    withName: SAMTOOLS_STATS {
        cpus = 2
        memory = '2.GB'
        time = '30.min'
        //publishDir = [
        //    path: { "${params.outdir}/results/qc/samtools_stats" },
        //    mode: 'copy',
        //    pattern: '*.stats'
        //]
    }
    
    withName: SAMTOOLS_IDXSTATS {
        cpus = 2
        memory = '1.GB'
        time = '15.min'
        //publishDir = [
        //    path: { "${params.outdir}/results/qc/idxstats" },
        //    mode: 'copy',
        //    pattern: '*.idxstats'
        //]
    }
    
    
    // ================================
    // CNV Analysis
    // ================================
    withName: GET_BIN_COUNTS {
        cpus = 2
        memory = '8.GB'
        time = '2.h'
	beforeScript = 'sleep 5; sync'  // Extra delay for large files
	// multi file publication
    	publishDir = [
	    path: { "${params.outdir}/results/varbin${resolution}k/stats" },
	    mode: 'copy',
	    pattern: "*.bin.counts.stats.bed",
	    saveAs: { filename ->
                def cell_id = filename.tokenize('.')[0]
            	def subdir = cell_id.size() >= 3 ? cell_id[0..1] : "zz"
            	"${subdir}/${filename}"
	    },
	    enabled: params.publish_varbin_outputs
	] 
   }
    
    withName: CNV_PROFILE {
        cpus = 2
        memory = '8.GB'
        time = '4.h'
    }
    
    withName: AGGREGATE_SEG_MATRICES {
        cpus = 2
        memory = { params.aggregate_seg_memory ?: '32.GB' }
        time = '2.h'
        publishDir = [
            path: { "${params.outdir}/results/cnv_summary" },
            mode: 'copy',
            pattern: 'matrix_*.txt'
        ]
    }
    
    withName: CNV_PLOIDY_SUMMARY {
        cpus = 1
        memory = '2.GB'
        time = '15.min'
        publishDir = [
            path: { "${params.outdir}/results/cnv_summary" },
            mode: 'copy',
            pattern: 'ploidy_summary_*.{txt,csv}'
        ]
    }
    
    withName: CREATE_CELL_PHENOTYPE_TEMPLATE {
        cpus = 1
        memory = '2.GB'
        time = '15.min'
        publishDir = [
            path: { "${params.outdir}/results/cnv_summary" },
            mode: 'copy',
            pattern: 'cell_phenotype.txt'
        ]
    }
}
